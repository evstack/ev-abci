FROM golang:1.24-alpine AS ignite-builder
ARG ENABLE_IBC=true

# Install dependencies needed for ignite and building
RUN apk add --no-cache \
    libc6-compat \
    curl \
    bash

# Set environment variables
ENV EVNODE_VERSION=v1.0.0-beta.9
ENV IGNITE_VERSION=v29.6.1
ENV IGNITE_EVOLVE_APP_VERSION=main

RUN curl -sSL https://get.ignite.com/cli@${IGNITE_VERSION}! | bash

WORKDIR /workspace

COPY . ./ev-abci

RUN ignite scaffold chain gm --no-module --skip-git --address-prefix gm

WORKDIR /workspace/gm

RUN ignite app install github.com/ignite/apps/evolve@${IGNITE_EVOLVE_APP_VERSION} && \
    ignite evolve add && \
    ignite evolve add-migrate

RUN go mod edit -replace github.com/evstack/ev-node=github.com/evstack/ev-node@${EVNODE_VERSION} && \
    go mod edit -replace github.com/evstack/ev-abci=/workspace/ev-abci && \
    go mod tidy

# TODO: replace this with proper ignite flag to skip IBC registration when available
# Patch out IBC registration (comment out the call and its error handling)
RUN if [ "$ENABLE_IBC" = "false" ]; then \
    echo "Disabling IBC registration..."; \
    awk 'BEGIN{c=0} /registerIBCModules\(appOpts\)/ {print "// "$0; c=2; next} {if (c>0) {print "// "$0; c--; next} } {print $0}' \
    app/app.go > app/app.go.tmp && mv app/app.go.tmp app/app.go; \
    else \
    echo "IBC enabled, leaving registration intact."; \
    fi

RUN ignite chain build --skip-proto

# Create lightweight runtime image for attester
FROM alpine:latest

# Install runtime dependencies
RUN apk add --no-cache ca-certificates curl jq bash

# Create attester user with stable UID/GID expected by integration tests
RUN addgroup -g 2000 attester && \
    adduser -D -G attester -u 2000 -h /home/attester -s /bin/bash attester

# Copy the gmd binary from the builder stage
COPY --from=ignite-builder /go/bin/gmd /usr/local/bin/gmd

# Verify binary is executable and present
RUN chmod +x /usr/local/bin/gmd

# Switch to attester user
USER attester
WORKDIR /home/attester

# Environment variables for reference (actual values passed via command)
ENV CHAIN_ID=gm
ENV GM_NODE=tcp://gm-chain:26657
ENV GM_HOME=/home/attester

# Health check - verify gmd attester process is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD pgrep -f "gmd attester" || exit 1

# Expose no ports (attester is a client only)

# Default command runs attester help (will be overridden in tests)
CMD ["gmd", "attester", "--help"]
