# Build a minimal gmd binary in this same Dockerfile
FROM golang:1.24-bookworm AS gmd-builder

# Install system dependencies - this layer will be cached
RUN apt-get update && apt-get install -y --no-install-recommends \
    git curl bash ca-certificates make gcc musl-dev && \
    rm -rf /var/lib/apt/lists/*

# Install Ignite CLI - cached if version doesn't change
ARG IGNITE_VERSION=latest
RUN curl -sSL https://get.ignite.com/cli@${IGNITE_VERSION}! | bash

WORKDIR /build
# Create a minimal GM app just to get the binary - cached if scaffold doesn't change
RUN ignite scaffold chain gm --no-module --skip-git --address-prefix gm
WORKDIR /build/gm
RUN go build -o /gmd ./cmd/gmd

FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl jq bash coreutils netcat-openbsd openssl wget git \
    && rm -rf /var/lib/apt/lists/*

# Copy gmd binary from the builder stage
COPY --from=gmd-builder /gmd /usr/local/bin/gmd
RUN chmod +x /usr/local/bin/gmd

# Download gaiad binary from official release - cached if GAIA_VERSION doesn't change
ARG GAIA_VERSION=v20.0.0
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then \
        wget -q https://github.com/cosmos/gaia/releases/download/${GAIA_VERSION}/gaiad-${GAIA_VERSION}-linux-amd64 -O /usr/local/bin/gaiad; \
    elif [ "$ARCH" = "arm64" ]; then \
        wget -q https://github.com/cosmos/gaia/releases/download/${GAIA_VERSION}/gaiad-${GAIA_VERSION}-linux-arm64 -O /usr/local/bin/gaiad; \
    else \
        echo "Unsupported architecture: $ARCH" && exit 1; \
    fi && \
    chmod +x /usr/local/bin/gaiad

# Create test user
RUN useradd -m -s /bin/bash tester

# Copy test scripts
COPY --chown=tester:tester integration-tests/scripts/run-integration-test.sh /home/tester/run-integration-test.sh
COPY --chown=tester:tester integration-tests/scripts/setup-ibc.sh /home/tester/setup-ibc.sh
COPY --chown=tester:tester integration-tests/scripts/test-transfers.sh /home/tester/test-transfers.sh
COPY --chown=tester:tester integration-tests/scripts/wait-for-chain.sh /home/tester/wait-for-chain.sh
COPY --chown=tester:tester integration-tests/scripts/wait-for-attester.sh /home/tester/wait-for-attester.sh

# Copy hermes config template
COPY --chown=tester:tester integration-tests/config/hermes.toml /home/tester/hermes.toml

# Make scripts executable
RUN chmod +x /home/tester/*.sh

# Switch to test user
USER tester
WORKDIR /home/tester

# Environment variables
ENV GM_RPC=http://gm-chain:26757
ENV GM_GRPC=http://gm-chain:9190
ENV GM_API=http://gm-chain:1417
ENV GAIA_RPC=http://gaia-chain:26657
ENV GAIA_GRPC=http://gaia-chain:9090
ENV GAIA_API=http://gaia-chain:1317
ENV HERMES_HOME=/home/tester/.hermes
