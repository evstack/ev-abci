# Build local-da from ev-node source
FROM golang:1.24-alpine AS builder

# Install build dependencies - this layer will be cached
RUN apk add --no-cache gcc musl-dev git

# Set working directory
WORKDIR /workspace

# Build local-da from rollkit module at the requested version (tag/branch/pseudo-version)
# This layer will be cached if EV_DA_REF doesn't change
ARG EV_DA_REF=main
RUN GOBIN=/workspace go install github.com/rollkit/rollkit/da/cmd/local-da@${EV_DA_REF}

# Runtime stage
FROM alpine:3.18

# Install runtime dependencies
RUN apk add --no-cache ca-certificates curl netcat-openbsd

# Copy binary from builder
COPY --from=builder /workspace/local-da /usr/local/bin/local-da

# Make binary executable
RUN chmod +x /usr/local/bin/local-da

# Expose port
EXPOSE 7980

# Default command
CMD ["local-da", "-listen-all"]
